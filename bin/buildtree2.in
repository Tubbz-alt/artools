#!/bin/bash
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

version=@version@

LIBDIR='@libdir@'
SYSCONFDIR='@sysconfdir@'
DATADIR='@datadir@'

[[ -r ${LIBDIR}/util-msg.sh ]] && source ${LIBDIR}/util-msg.sh
import ${LIBDIR}/util.sh
import ${LIBDIR}/util-pkg.sh
import ${LIBDIR}/util-pkg-tree2.sh

display_settings(){
    show_version
    show_config

    msg "REPOS:"
    msg2 "repo_tree_artix: %s" "${repo_tree_artix[*]}"
    msg2 "repo_tree_arch: %s" "${repo_tree_arch[*]}"

    msg "OPTIONS:"
    msg2 "repository: %s" "${repository}"
    msg2 "package: %s" "${package}"

    msg "ARGS:"
    msg2 "artix: %s" "${artix}"
    msg2 "arch: %s" "${arch}"
    msg2 "create: %s" "${create}"
    msg2 "add_subtree: %s" "${add_subtree}"
    msg2 "import_arch: %s" "${import_arch}"

    msg "PATHS:"
    msg2 "tree_dir_artix: %s" "${tree_dir_artix}"
    msg2 "tree_dir_arch: %s" "${tree_dir_arch}"
    msg2 "patches_dir: %s" "${patches_dir}/${repository}"
}

load_user_info

load_config "${AT_USERCONFDIR}/artools.conf" || load_config "${SYSCONFDIR}/artools.conf"

pretend=false
arch=false
artix=false
import_arch=false
create=false
add_subtree=false
repository='packages'
package=''

rsync_args=(-aWxvci --progress --delete-before --no-R --no-implied-dirs)

usage() {
    echo "Usage: ${0##*/} [options]"
    echo "    -r <repo>     Repository [default:${repository}]"
    echo "    -p <pkg>      Package [default:${package}]"
    echo "    -a            Sync arch tree"
    echo "    -b            Sync artix tree"
    echo "    -c            Create package repo"
    echo "    -s            Add subtree"
    echo '    -i            Import arch packages'
    echo '    -q            Query settings'
    echo '    -h            This help'
    echo ''
    echo ''
    exit $1
}

orig_argv=("$0" "$@")

opts='r:p:abcsiqh'

while getopts "${opts}" arg; do
    case "${arg}" in
        r) repository="$OPTARG" ;;
        p) package="$OPTARG" ;;
        a) arch=true ;;
        b) artix=true ;;
        c) create=true ;;
        s) add_subtree=true ;;
        i) import_arch=true ;;
        q) pretend=true ;;
        h|?) usage 0 ;;
        *) echo "invalid argument '${arg}'"; usage 1 ;;
    esac
done

shift $(($OPTIND - 1))

prepare_dir "${tree_dir_artix}"
prepare_dir "${tree_dir_arch}"
prepare_dir "${patches_dir}/${repository}"

${pretend} && display_settings && exit 1

${artix} && sync_tree_artix

${arch} && sync_tree_arch

${create} && create_pkg_repo "${repository}" "${package}"

${add_subtree} && add_pkg_subtree "${repository}" "${package}"

${import_arch} && import_from_arch "${repository}"
